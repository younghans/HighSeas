<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Simulator</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>Sailing Simulator</h2>
        <p>Left-click: Move ship to location</p>
        <p>Right-click drag: Move camera</p>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.174.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.174.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        console.log('Script starting...');
        
        import * as THREE from 'three';
        console.log('THREE imported successfully:', THREE.REVISION);
        
        // Import our modules - using async import to handle any loading issues
        async function initApp() {
            try {
                console.log('Loading modules...');
                
                // Import world module
                const worldModule = await import('./js/world.js');
                console.log('world.js imported successfully');
                
                // Import ship module
                const shipModule = await import('./js/ship.js');
                console.log('ship.js imported successfully');
                
                // Import controls module
                const controlsModule = await import('./js/controls.js');
                console.log('controls.js imported successfully');
                
                // Import wind wisps module
                const windModule = await import('./js/windwisps.js');
                console.log('windwisps.js imported successfully');
                
                // Main game variables
                let scene, camera, renderer;
                let clock = new THREE.Clock();
                let windWisps;
                
                // Initialize the scene
                function init() {
                    console.log('Initializing scene...');
                    
                    // Create scene
                    scene = new THREE.Scene();
                    console.log('Scene created');
                    
                    // Create camera
                    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 20000);
                    camera.position.set(0, 10, 20);
                    camera.lookAt(0, 0, 0);
                    console.log('Camera created');

                    // Create renderer
                    renderer = new THREE.WebGLRenderer({ antialias: true });
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.toneMapping = THREE.ACESFilmicToneMapping;
                    renderer.toneMappingExposure = 0.2;
                    renderer.shadowMap.enabled = true;
                    document.body.appendChild(renderer.domElement);
                    console.log('Renderer created and added to DOM');

                    // Create sky and sun
                    console.log('Creating sky...');
                    worldModule.createModernSky(scene, renderer);
                    console.log('Sky created');

                    // Add lighting
                    console.log('Setting up lighting...');
                    worldModule.setupLighting(scene);
                    console.log('Lighting set up');

                    // Create HD water
                    console.log('Creating water...');
                    worldModule.createHDWater(scene);
                    console.log('Water created');

                    // Create ship
                    console.log('Creating ship...');
                    shipModule.createShip(scene);
                    console.log('Ship created');
                    
                    // Create wake emitters
                    console.log('Creating wake emitters...');
                    shipModule.createWakeEmitters(scene);
                    console.log('Wake emitters created');

                    // Create wind wisps
                    console.log('Creating wind wisps...');
                    const windDirection = new THREE.Vector3(1, 0, 0.5).normalize();
                    const windSpeed = 15;
                    windWisps = new windModule.WindWisps(scene, camera, windDirection, windSpeed);
                    
                    // Configure wind variation
                    windWisps.setWindVariation(0.6, Math.PI / 2); // 60% strength, up to 90 degrees change
                    console.log('Wind wisps created');
                    
                    // Setup controls
                    console.log('Setting up controls...');
                    controlsModule.setupControls(camera, renderer, shipModule.ship, worldModule.water);
                    console.log('Controls set up');

                    // Handle window resize
                    window.addEventListener('resize', onWindowResize);

                    // Create stars
                    console.log('Creating stars...');
                    worldModule.createStars(scene);
                    console.log('Stars created');
                    
                    // Start animation loop
                    console.log('Starting animation loop...');
                    animate();
                }

                function onWindowResize() {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }

                function animate() {
                    requestAnimationFrame(animate);
                    
                    const delta = clock.getDelta();
                    const time = performance.now() * 0.001;
                    
                    // No need to recalculate sun position if it's fixed
                    // Just update the sky uniforms if needed
                    if (worldModule.sky && worldModule.sky.material && worldModule.sky.material.uniforms) {
                        worldModule.sky.material.uniforms['sunPosition'].value.copy(worldModule.sun);
                    }
                    
                    // Update stars visibility and intensity
                    if (worldModule.stars) {
                        worldModule.stars.visible = false; // Always hide stars since it's always daytime
                    }
                    
                    // Update water animation
                    if (worldModule.water && worldModule.water.material && worldModule.water.material.uniforms) {
                        
                        // Animate water - reduced speed by 5x
                        worldModule.water.material.uniforms['time'].value += 1.0 / 300.0;
                    }
                    
                    // Move ship towards target and get movement status
                    // Pass the ship object directly from the shipModule
                    const shipIsMoving = controlsModule.updateShipMovement(shipModule.ship, delta, time);
                    
                    // Emit wake particles if ship is moving
                    if (shipIsMoving) {
                        shipModule.emitWakeParticles(shipIsMoving, delta);
                    }
                    
                    // Update wake particles regardless of movement (to let active ones fade out)
                    shipModule.updateWakeParticles(delta);
                    
                    // Update wind wisps
                    if (windWisps) {
                        windWisps.update(delta);
                    }
                    
                    // Update controls
                    if (controlsModule.controls) {
                        controlsModule.controls.update();
                    }
                    
                    // Render scene
                    renderer.render(scene, camera);
                }

                // Start the application
                console.log('Calling init()...');
                init();
                console.log('init() completed');
                
            } catch (error) {
                console.error('Error initializing application:', error);
                document.body.innerHTML = `
                    <div style="color: red; padding: 20px;">
                        <h1>Error Loading Application</h1>
                        <p>${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        // Start the application
        initApp().catch(error => {
            console.error('Fatal error during initialization:', error);
            document.body.innerHTML = `
                <div style="color: red; padding: 20px;">
                    <h1>Error Loading Application</h1>
                    <p>${error.message}</p>
                    <pre>${error.stack}</pre>
                </div>
            `;
        });
    </script>
</body>
</html> 